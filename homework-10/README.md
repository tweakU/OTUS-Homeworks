## Домашнее задание № 10 — «Bash»

Цель домашнего задания: написать скрипт на языке Bash в операционной системе (ОС) GNU/Linux.

Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.  

Необходимая информация в письме:  
1 Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;  
2 Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;  
3 Ошибки веб-сервера/приложения c момента последнего запуска;  
4 Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.  
5 Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.  
В письме должен быть прописан обрабатываемый временной диапазон.


Выполнение домашнего задания:

п.1 Парсим access.log (п.2, 3 и 4 выполняются аналогично п.1):  
awk извлекает список IP адресов  
sort сортирует полученный список  
uniq -c отображает повторяющиеся строки, ключ -c добавляет информацию о количестве повторений  
sort -n сортирует строки по числовому значению  
tail без ключей выводит 10 строк с конца 
```console
awk '{ print $1}' "./access-4560-644067.log" | sort | uniq -c | sort -n | tail
```

п.5 лочим скрипт с помощью flock:
```console
#!/bin/bash

# Захват блокировки
exec 200>./hw10.lock
flock -n 200 || {
  echo "$(date)"
  echo "Script already running. Exiting..."
  exit 1
}
```

Проверяем работу flock из второго окна теминала:
<img width="1366" height="728" alt="изображение" src="https://github.com/user-attachments/assets/5447c168-1c0e-4db6-8378-718d5f34c4fc" />

Пишем следующих модуль скрипта, который будет отслеживать новые записи в лог файл:
```console
#!/bin/bash

# Путь к log файлу
LOG=./access-4560-644067.log

# Файл для хранения позиции последнего прочитанного байта
STATE_FILE="./last_position.txt"

# Если состояние не существует, создаём его с начальной позицией 0
if [ ! -f "$STATE_FILE" ]; then
  echo 0 > "$STATE_FILE"
fi

# Чтение последней позиции
LAST_POS=$(cat "$STATE_FILE")

# Чтение новых данных из лога (с позиции LAST_POS)
NEW_LOG=$(tail -c +$((LAST_POS + 1)) "$LOG")

# Если в логе появились новые строки, парсим их
if [ -n "$NEW_LOG" ]; then
  echo "$NEW_LOG" | awk '{print $1}' | sort | uniq -c | sort -n
else
  echo "There are no changes"
fi

# Обновляем позицию последнего прочитанного байта
NEW_POS=$(stat -c %s "$LOG")
echo "$NEW_POS" > "$STATE_FILE"
```

Для отправки писем с помощью cron можно использовать команду mail из пакета mailutils.  
Установим его:
```console
funt1k@ubuntu24043:~/tmp$ sudo apt-get install mailutils
```

Настроим cron:
```console
funt1k@ubuntu24043:~$ crontab -e

1 * * * * /home/funt1k/tmp/hw10.sh | mail -s "Apache Log Report" user@example.com
```

Домашнее задание выполнено.

<br/>

[Вернуться к списку всех ДЗ](../README.md)
